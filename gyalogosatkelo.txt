#include <Adafruit_LiquidCrystal.h>   // LCD kijelző könyvtára

Adafruit_LiquidCrystal lcd_1(0);       // LCD objektum (0 → alap I2C emuláció)


// ---- KIVEZETÉSEK DEFINIÁLÁSA ----
// Autó jelzőlámpa LED-ek
const int autoPiros = 2;
const int autoSarga = 3;
const int autoZold  = 4;

// Gyalogos jelzőlámpa LED-ek
const int gyalogPiros = 5;
const int gyalogZold  = 6;

// Hangjelző (buzzer) és kérőgomb
const int buzzer = 7;
const int gomb   = 8;

// Üzemmódváltó gomb ("üzemen kívül" mód)
const int uzemGomb = 9;


// ---- ÁLLAPOTVÁLTOZÓK ----
bool gyalogMod = false;               // Gyalogos mód be/ki
bool elozoAllapot = HIGH;             // Kérőgomb előző állapota

bool uzemenKivul = false;             // Üzemen kívül mód állapota
bool elozoUzemAllapot = HIGH;         // Üzemgomb előző állapota



void setup() {

  // LED-ek beállítása kimenetként
  pinMode(autoPiros, OUTPUT);
  pinMode(autoSarga, OUTPUT);
  pinMode(autoZold, OUTPUT);

  pinMode(gyalogPiros, OUTPUT);
  pinMode(gyalogZold, OUTPUT);

  pinMode(buzzer, OUTPUT);

  // Gombok bemenetként (felhúzó ellenállással)
  pinMode(gomb, INPUT_PULLUP);
  pinMode(uzemGomb, INPUT_PULLUP);

  // LCD inicializálás
  lcd_1.begin(16, 2);
  lcd_1.setBacklight(1);

  // Kezdő állapot: autó mehet, gyalogos tilos
  digitalWrite(autoZold, HIGH);
  digitalWrite(autoPiros, LOW);
  digitalWrite(autoSarga, LOW);

  digitalWrite(gyalogPiros, HIGH);
  digitalWrite(gyalogZold, LOW);

  // LCD kezdő szöveg
  lcd_1.clear();
  lcd_1.setCursor(0, 0);
  lcd_1.print("Kerem varjon...");
}



void loop() {

  // ---- ÜZEMMÓD GOMB FIGYELÉSE ----
  bool uzemJelenlegi = digitalRead(uzemGomb);

  // Élérzékelés
  if (elozoUzemAllapot == HIGH && uzemJelenlegi == LOW) {

    uzemenKivul = !uzemenKivul;   // módváltás

    if (uzemenKivul) {
      // ---- UZEMEN KÍVÜL MÓD ----

      // Minden LED kikapcsolása
      digitalWrite(autoZold, LOW);
      digitalWrite(autoSarga, LOW);
      digitalWrite(autoPiros, LOW);

      digitalWrite(gyalogZold, LOW);
      digitalWrite(gyalogPiros, LOW);

      lcd_1.clear();
      lcd_1.setCursor(0, 0);
      lcd_1.print("Uzemen kivul");

    } else {
      // ---- VISSZA NORMAL MÓDRA ----

      lcd_1.clear();
      lcd_1.setCursor(0, 0);
      lcd_1.print("Kerem varjon...");

      digitalWrite(autoPiros, LOW);
      digitalWrite(autoZold, HIGH);
      digitalWrite(autoSarga, LOW);

      digitalWrite(gyalogPiros, HIGH);
      digitalWrite(gyalogZold, LOW);
    }

    delay(200); // pergésgátlás
  }

  elozoUzemAllapot = uzemJelenlegi;



  // ---- UZEMEN KÍVÜL: SÁRGA VILLÓZIK ----
  if (uzemenKivul) {
    digitalWrite(autoSarga, HIGH);
    delay(400);
    digitalWrite(autoSarga, LOW);
    delay(400);
    return; // kilépés, nem működik a normál logika
  }


  // ---- GYALOGOS GOMB FIGYELÉSE ----
  bool jelenlegi = digitalRead(gomb);

  if (elozoAllapot == HIGH && jelenlegi == LOW) {

    gyalogMod = !gyalogMod;

    // ======== GYALOGOS MÓD BEKAPCSOLÁSA ========
    if (gyalogMod) {

      // Autó: zöld → sárga → piros
      digitalWrite(autoZold, LOW);

      digitalWrite(autoSarga, HIGH);
      delay(3000);
      digitalWrite(autoSarga, LOW);

      digitalWrite(autoPiros, HIGH);

      // Gyalogos zöld
      digitalWrite(gyalogPiros, LOW);
      digitalWrite(gyalogZold, HIGH);

      lcd_1.clear();
      lcd_1.setCursor(0, 0);
      lcd_1.print("Atkelhet!");

      // Buzzer alap hang
      tone(buzzer, 1500);



      // -------------------------------------------------
      //      *** 15 MP GYALOGOS ZÖLD ***
      //
      // 12 másodpercig folyamatos zöld
      // Utolsó 3 másodperc → villogás
      // -------------------------------------------------

      delay(12000);   // 12 mp folyamatos zöld


      // ---- UTOLSÓ 3 MÁSODPERC VILLOGÁS ----
      for (int i = 0; i < 6; i++) {  // 6× 0.5 mp = 3 mp
        digitalWrite(gyalogZold, LOW);
        noTone(buzzer);
        delay(250);

        digitalWrite(gyalogZold, HIGH);
        tone(buzzer, 2000);
        delay(250);
      }



      // ---- VISSZA PIROSRA ----
      digitalWrite(gyalogZold, LOW);
      digitalWrite(gyalogPiros, HIGH);
      noTone(buzzer);

      lcd_1.clear();
      lcd_1.setCursor(0, 0);
      lcd_1.print("Kerem varjon...");


      // Autók visszarendezése: piros → sárga → zöld
      digitalWrite(autoPiros, LOW);

      digitalWrite(autoSarga, HIGH);
      delay(3000);
      digitalWrite(autoSarga, LOW);

      digitalWrite(autoZold, HIGH);

      gyalogMod = false;   // gyalog mód lezárása



    // ======== GYALOGOS MÓD KIKAPCSOLÁSA ========
    } else {

      // Biztonsági: buzzer leállítás
      noTone(buzzer);

      // Rövid figyelmeztető villogás
      for (int i = 0; i < 5; i++) {
        digitalWrite(gyalogZold, HIGH);
        tone(buzzer, 2000);
        delay(100);

        digitalWrite(gyalogZold, LOW);
        noTone(buzzer);
        delay(100);
      }

      // Gyalogos piros
      digitalWrite(gyalogZold, LOW);
      digitalWrite(gyalogPiros, HIGH);

      lcd_1.clear();
      lcd_1.setCursor(0, 0);
      lcd_1.print("Kerem varjon...");

      // Autók visszarendezése
      digitalWrite(autoPiros, LOW);

      digitalWrite(autoSarga, HIGH);
      delay(3000);
      digitalWrite(autoSarga, LOW);

      digitalWrite(autoZold, HIGH);
    }

    delay(200);  // pergésgátlás
  }

  elozoAllapot = jelenlegi; // gomb előző állapota
}
